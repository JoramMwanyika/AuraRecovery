{% extends "base.html" %}

{% block title %}Manage {{ group.name }} - AuraRecovery{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-aura-gray via-gray-50 to-aura-gray dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 transition-colors duration-300">
    <!-- Enhanced Header -->
    <header class="bg-white/90 dark:bg-gray-900/90 backdrop-blur-xl shadow-lg border-b border-gray-200/30 dark:border-gray-700/30 sticky top-0 z-40">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <a href="{{ url_for('group_detail', group_id=group.id) }}" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:text-aura-blue transition-all duration-300 group">
                        <div class="w-10 h-10 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center group-hover:bg-aura-blue group-hover:text-white transition-all duration-300">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </div>
                        <span class="font-medium">Back to Group</span>
                    </a>
                    
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i data-lucide="shield-check" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-aura-charcoal dark:text-white">Group Management</h1>
                            <p class="text-gray-600 dark:text-gray-400">{{ group.name }}</p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Quick Stats -->
                    <div class="hidden md:flex items-center space-x-6 bg-gray-50 dark:bg-gray-800 rounded-xl px-4 py-2">
                        <div class="text-center">
                            <div class="text-lg font-bold text-aura-blue">{{ approved_members|length }}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">Members</div>
                        </div>
                        <div class="w-px h-8 bg-gray-300 dark:bg-gray-600"></div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-yellow-500">{{ pending_requests|length }}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">Pending</div>
                        </div>
                    </div>
                    
                    <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 flex items-center justify-center">
                        <i data-lucide="sun" class="w-5 h-5 text-yellow-500 hidden dark:block"></i>
                        <i data-lucide="moon" class="w-5 h-5 text-gray-600 block dark:hidden"></i>
                    </button>
                    
                    <div class="flex items-center space-x-3 bg-aura-green/10 rounded-xl px-3 py-2">
                        <div class="w-8 h-8 bg-aura-green rounded-lg flex items-center justify-center">
                            <span class="text-sm font-bold text-aura-charcoal">{{ current_user.first_name[0] }}{{ current_user.last_name[0] }}</span>
                        </div>
                        <div class="hidden sm:block">
                            <div class="text-sm font-medium text-aura-charcoal dark:text-white">{{ current_user.first_name }} {{ current_user.last_name }}</div>
                            <div class="text-xs text-purple-600 dark:text-purple-400 font-medium">{{ user_role.title() }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Enhanced Group Info Card -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 mb-8 border border-gray-200/50 dark:border-gray-700/50">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-6 lg:space-y-0">
                <div class="flex items-center space-x-6">
                    <div class="w-20 h-20 bg-gradient-to-br from-aura-blue via-aura-blue-dark to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i data-lucide="users" class="w-10 h-10 text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-aura-charcoal dark:text-white mb-2">{{ group.name }}</h2>
                        <div class="flex flex-wrap items-center gap-3 mb-3">
                            <span class="bg-aura-blue/10 text-aura-blue px-3 py-1 rounded-full text-sm font-medium">{{ group.group_type }}</span>
                            <span class="bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300 px-3 py-1 rounded-full text-sm font-medium">{{ group.language.title() }}</span>
                            <span class="bg-purple-100 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 px-3 py-1 rounded-full text-sm font-medium">{{ group.addiction_focus.title() }}</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 max-w-2xl">{{ group.description }}</p>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="showGroupSettingsModal()" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl transition-all duration-300 font-medium flex items-center justify-center">
                        <i data-lucide="settings" class="w-5 h-5 mr-2"></i>
                        Group Settings
                    </button>
                    <button onclick="showInviteModal()" class="bg-aura-blue hover:bg-aura-blue-dark text-white px-6 py-3 rounded-xl transition-all duration-300 font-medium flex items-center justify-center shadow-lg">
                        <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                        Invite Members
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Management Grid -->
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Pending Requests - Enhanced -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-aura-charcoal dark:text-white">Pending Requests</h2>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Review and approve new members</p>
                                </div>
                            </div>
                            {% if pending_requests %}
                            <div class="flex items-center space-x-3">
                                <span class="bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                    {{ pending_requests|length }} pending
                                </span>
                                <button onclick="approveAllRequests()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                                    <i data-lucide="check-circle" class="w-4 h-4 mr-1 inline"></i>
                                    Approve All
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="p-6">
                        {% if pending_requests %}
                            <div class="space-y-4" id="pending-requests-container">
                                {% for request in pending_requests %}
                                <div id="request-{{ request.id }}" class="group bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl p-6 hover:shadow-lg transition-all duration-300 hover:border-aura-blue/50">
                                    <div class="flex items-start justify-between">
                                        <div class="flex items-start space-x-4 flex-1">
                                            <div class="relative">
                                                <div class="w-14 h-14 bg-gradient-to-br from-aura-green to-green-500 rounded-xl flex items-center justify-center shadow-lg">
                                                    <span class="text-lg font-bold text-white">{{ request.user.first_name[0] }}{{ request.user.last_name[0] }}</span>
                                                </div>
                                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-yellow-500 rounded-full border-2 border-white dark:border-gray-800 flex items-center justify-center">
                                                    <i data-lucide="clock" class="w-3 h-3 text-white"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <h4 class="text-lg font-bold text-aura-charcoal dark:text-white">
                                                        {{ request.user.first_name }} {{ request.user.last_name }}
                                                    </h4>
                                                    {% if request.user.user_type %}
                                                    <span class="bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 px-2 py-1 rounded-lg text-xs font-medium">
                                                        {{ request.user.user_type.replace('_', ' ').title() }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="space-y-2">
                                                    <div class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
                                                        <i data-lucide="mail" class="w-4 h-4"></i>
                                                        <span>{{ request.user.email }}</span>
                                                    </div>
                                                    
                                                    {% if request.user.country %}
                                                    <div class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
                                                        <i data-lucide="map-pin" class="w-4 h-4"></i>
                                                        <span>{{ request.user.country }}</span>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-500">
                                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                                        <span>Requested {{ request.joined_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                                                    </div>
                                                </div>
                                                
                                                {% if request.user.recovery_goals %}
                                                <div class="mt-3 p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Recovery Goals:</div>
                                                    <div class="flex flex-wrap gap-1">
                                                        {% for goal in request.user.recovery_goals|from_json %}
                                                        <span class="bg-aura-blue/10 text-aura-blue px-2 py-1 rounded text-xs">{{ goal }}</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="flex flex-col space-y-2 ml-4">
                                            <button onclick="approveMembership({{ request.id }}, '{{ request.user.first_name }} {{ request.user.last_name }}')" 
                                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center">
                                                <i data-lucide="check" class="w-4 h-4 mr-2"></i>
                                                Approve
                                            </button>
                                            <button onclick="rejectMembership({{ request.id }}, '{{ request.user.first_name }} {{ request.user.last_name }}')" 
                                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center">
                                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                                Reject
                                            </button>
                                            <button onclick="viewUserProfile({{ request.user.id }})" 
                                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium flex items-center">
                                                <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                                                Profile
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-12">
                                <div class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                    <i data-lucide="inbox" class="w-10 h-10 text-gray-400"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No pending requests</h3>
                                <p class="text-gray-500 dark:text-gray-500 mb-6">All membership requests have been processed.</p>
                                <button onclick="showInviteModal()" class="bg-aura-blue hover:bg-aura-blue-dark text-white px-6 py-3 rounded-xl transition-colors font-medium">
                                    <i data-lucide="user-plus" class="w-5 h-5 mr-2 inline"></i>
                                    Invite New Members
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Current Members - Enhanced -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="bg-gradient-to-r from-aura-blue/10 to-purple-100/50 dark:from-aura-blue/20 dark:to-purple-900/20 p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-aura-blue rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="users" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-aura-charcoal dark:text-white">Members</h2>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ approved_members|length }}/{{ group.max_members }} members</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-aura-blue">{{ approved_members|length }}</div>
                                <div class="text-xs text-gray-500">Active</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                            {% for member in approved_members %}
                            <div id="member-{{ member.id }}" class="group flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 border border-transparent hover:border-aura-blue/30">
                                <div class="flex items-center space-x-3 flex-1 min-w-0">
                                    <div class="relative">
                                        <div class="w-10 h-10 bg-gradient-to-br from-aura-green to-green-500 rounded-lg flex items-center justify-center shadow-md">
                                            <span class="text-sm font-bold text-white">{{ member.user.first_name[0] }}{{ member.user.last_name[0] }}</span>
                                        </div>
                                        {% if member.role == 'facilitator' %}
                                        <div class="absolute -top-1 -right-1 w-4 h-4 bg-purple-500 rounded-full border-2 border-white dark:border-gray-800 flex items-center justify-center">
                                            <i data-lucide="crown" class="w-2 h-2 text-white"></i>
                                        </div>
                                        {% elif member.role == 'moderator' %}
                                        <div class="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-white dark:border-gray-800 flex items-center justify-center">
                                            <i data-lucide="shield" class="w-2 h-2 text-white"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-2">
                                            <h4 class="font-semibold text-aura-charcoal dark:text-white truncate">
                                                {{ member.user.first_name }} {{ member.user.last_name }}
                                            </h4>
                                            {% if member.user.id == current_user.id %}
                                            <span class="text-xs text-aura-blue font-medium">(You)</span>
                                            {% endif %}
                                        </div>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <span class="text-xs px-2 py-1 rounded-full font-medium
                                                {% if member.role == 'facilitator' %}bg-purple-100 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300
                                                {% elif member.role == 'moderator' %}bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300
                                                {% else %}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400{% endif %}">
                                                {{ member.role.title() }}
                                            </span>
                                            <span class="text-xs text-gray-500 dark:text-gray-500">
                                                {{ member.approved_at.strftime('%b %d') if member.approved_at else member.joined_at.strftime('%b %d') }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if user_role == 'facilitator' and member.user.id != current_user.id and member.role != 'facilitator' %}
                                <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                    <button onclick="showMemberActions({{ member.id }}, '{{ member.user.first_name }} {{ member.user.last_name }}', '{{ member.role }}')" 
                                            class="text-gray-400 hover:text-red-500 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-300">
                                        <i data-lucide="more-vertical" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full transform transition-all duration-300 scale-95" id="confirmModalContent">
        <div class="p-8">
            <div class="flex items-center space-x-4 mb-6">
                <div id="confirmIcon" class="w-12 h-12 rounded-xl flex items-center justify-center"></div>
                <div>
                    <h3 id="confirmTitle" class="text-xl font-bold text-aura-charcoal dark:text-white"></h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">This action requires confirmation</p>
                </div>
            </div>
            
            <p id="confirmMessage" class="text-gray-600 dark:text-gray-400 mb-8 leading-relaxed"></p>
            
            <div class="flex justify-end space-x-4">
                <button onclick="hideConfirmModal()" class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-300 font-medium">
                    Cancel
                </button>
                <button id="confirmButton" class="px-6 py-3 rounded-xl transition-all duration-300 font-medium shadow-lg">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Member Actions Modal -->
<div id="memberActionsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full">
        <div class="p-6">
            <h3 class="text-lg font-bold text-aura-charcoal dark:text-white mb-4">Member Actions</h3>
            <div class="space-y-2">
                <button onclick="promoteMember()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 text-blue-600 dark:text-blue-400 transition-colors">
                    <i data-lucide="arrow-up" class="w-4 h-4 mr-3 inline"></i>
                    Promote to Moderator
                </button>
                <button onclick="removeMemberAction()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 transition-colors">
                    <i data-lucide="user-minus" class="w-4 h-4 mr-3 inline"></i>
                    Remove from Group
                </button>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button onclick="hideMemberActionsModal()" class="w-full px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-2xl">
        <div class="flex items-center space-x-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-aura-blue"></div>
            <span class="text-lg font-medium text-aura-charcoal dark:text-white">Processing...</span>
        </div>
    </div>
</div>

<style>
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.dark .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #4b5563;
}

.dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
}
</style>

<script>
    let pendingAction = null;
    let currentMemberId = null;
    let currentMemberName = null;
    let currentMemberRole = null;

    function showLoading() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    async function approveMembership(membershipId, memberName) {
        // Show confirmation
        document.getElementById('confirmIcon').innerHTML = '<i data-lucide="check-circle" class="w-6 h-6 text-white"></i>';
        document.getElementById('confirmIcon').className = 'w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center';
        document.getElementById('confirmTitle').textContent = 'Approve Member';
        document.getElementById('confirmMessage').textContent = `Are you sure you want to approve ${memberName} to join this group? They will gain access to group chat and sessions.`;
        document.getElementById('confirmButton').textContent = 'Approve';
        document.getElementById('confirmButton').className = 'px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl transition-all duration-300 font-medium shadow-lg';
        
        pendingAction = () => executeApproveMembership(membershipId, memberName);
        document.getElementById('confirmModal').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('confirmModalContent').classList.remove('scale-95');
            document.getElementById('confirmModalContent').classList.add('scale-100');
        }, 10);
    }

    async function executeApproveMembership(membershipId, memberName) {
        showLoading();
        hideConfirmModal();
        
        try {
            const response = await fetch(`/api/membership/${membershipId}/approve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                // Animate removal
                const requestElement = document.getElementById(`request-${membershipId}`);
                if (requestElement) {
                    requestElement.style.transform = 'translateX(100%)';
                    requestElement.style.opacity = '0';
                    setTimeout(() => {
                        requestElement.remove();
                        updatePendingCount();
                    }, 300);
                }
                
                showFlashMessage(`${memberName} has been approved and can now access the group!`, 'success');
                
                // Refresh member list after a delay
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showFlashMessage(data.message, 'error');
            }
        } catch (error) {
            console.error('Error approving membership:', error);
            showFlashMessage('Error approving membership. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }

    async function rejectMembership(membershipId, memberName) {
        // Show confirmation
        document.getElementById('confirmIcon').innerHTML = '<i data-lucide="x-circle" class="w-6 h-6 text-white"></i>';
        document.getElementById('confirmIcon').className = 'w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center';
        document.getElementById('confirmTitle').textContent = 'Reject Member';
        document.getElementById('confirmMessage').textContent = `Are you sure you want to reject ${memberName}'s request to join this group? This action cannot be undone.`;
        document.getElementById('confirmButton').textContent = 'Reject';
        document.getElementById('confirmButton').className = 'px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl transition-all duration-300 font-medium shadow-lg';
        
        pendingAction = () => executeRejectMembership(membershipId, memberName);
        document.getElementById('confirmModal').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('confirmModalContent').classList.remove('scale-95');
            document.getElementById('confirmModalContent').classList.add('scale-100');
        }, 10);
    }

    async function executeRejectMembership(membershipId, memberName) {
        showLoading();
        hideConfirmModal();
        
        try {
            const response = await fetch(`/api/membership/${membershipId}/reject`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                // Animate removal
                const requestElement = document.getElementById(`request-${membershipId}`);
                if (requestElement) {
                    requestElement.style.transform = 'translateX(-100%)';
                    requestElement.style.opacity = '0';
                    setTimeout(() => {
                        requestElement.remove();
                        updatePendingCount();
                    }, 300);
                }
                
                showFlashMessage(`${memberName}'s request has been rejected.`, 'info');
            } else {
                showFlashMessage(data.message, 'error');
            }
        } catch (error) {
            console.error('Error rejecting membership:', error);
            showFlashMessage('Error rejecting membership. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }

    async function approveAllRequests() {
        const pendingRequests = document.querySelectorAll('[id^="request-"]');
        if (pendingRequests.length === 0) return;
        
        document.getElementById('confirmIcon').innerHTML = '<i data-lucide="check-circle-2" class="w-6 h-6 text-white"></i>';
        document.getElementById('confirmIcon').className = 'w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center';
        document.getElementById('confirmTitle').textContent = 'Approve All Requests';
        document.getElementById('confirmMessage').textContent = `Are you sure you want to approve all ${pendingRequests.length} pending requests? All users will gain access to the group.`;
        document.getElementById('confirmButton').textContent = 'Approve All';
        document.getElementById('confirmButton').className = 'px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl transition-all duration-300 font-medium shadow-lg';
        
        pendingAction = executeApproveAllRequests;
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    async function executeApproveAllRequests() {
        showLoading();
        hideConfirmModal();
        
        const pendingRequests = document.querySelectorAll('[id^="request-"]');
        let successCount = 0;
        
        for (const requestElement of pendingRequests) {
            const membershipId = requestElement.id.replace('request-', '');
            try {
                const response = await fetch(`/api/membership/${membershipId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    successCount++;
                    requestElement.style.transform = 'translateX(100%)';
                    requestElement.style.opacity = '0';
                }
            } catch (error) {
                console.error('Error approving membership:', error);
            }
        }
        
        hideLoading();
        showFlashMessage(`Successfully approved ${successCount} members!`, 'success');
        
        setTimeout(() => {
            location.reload();
        }, 2000);
    }

    function showMemberActions(memberId, memberName, memberRole) {
        currentMemberId = memberId;
        currentMemberName = memberName;
        currentMemberRole = memberRole;
        document.getElementById('memberActionsModal').classList.remove('hidden');
    }

    function hideMemberActionsModal() {
        document.getElementById('memberActionsModal').classList.add('hidden');
        currentMemberId = null;
        currentMemberName = null;
        currentMemberRole = null;
    }

    function removeMemberAction() {
        hideMemberActionsModal();
        
        document.getElementById('confirmIcon').innerHTML = '<i data-lucide="user-minus" class="w-6 h-6 text-white"></i>';
        document.getElementById('confirmIcon').className = 'w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center';
        document.getElementById('confirmTitle').textContent = 'Remove Member';
        document.getElementById('confirmMessage').textContent = `Are you sure you want to remove ${currentMemberName} from this group? This action cannot be undone and they will lose access to all group content.`;
        document.getElementById('confirmButton').textContent = 'Remove';
        document.getElementById('confirmButton').className = 'px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl transition-all duration-300 font-medium shadow-lg';
        
        pendingAction = () => executeRemoveMember(currentMemberId);
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    async function executeRemoveMember(membershipId) {
        showLoading();
        hideConfirmModal();
        
        try {
            const response = await fetch(`/api/membership/${membershipId}/remove`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                const memberElement = document.getElementById(`member-${membershipId}`);
                if (memberElement) {
                    memberElement.style.transform = 'translateX(-100%)';
                    memberElement.style.opacity = '0';
                    setTimeout(() => {
                        memberElement.remove();
                    }, 300);
                }
                
                showFlashMessage(`${currentMemberName} has been removed from the group.`, 'info');
            } else {
                showFlashMessage(data.message, 'error');
            }
        } catch (error) {
            console.error('Error removing member:', error);
            showFlashMessage('Error removing member. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }

    function hideConfirmModal() {
        document.getElementById('confirmModalContent').classList.remove('scale-100');
        document.getElementById('confirmModalContent').classList.add('scale-95');
        setTimeout(() => {
            document.getElementById('confirmModal').classList.add('hidden');
        }, 150);
        pendingAction = null;
    }

    function updatePendingCount() {
        const pendingRequests = document.querySelectorAll('[id^="request-"]');
        const countElements = document.querySelectorAll('.pending-count');
        countElements.forEach(el => {
            el.textContent = pendingRequests.length;
        });
    }

    function viewUserProfile(userId) {
        // Placeholder for user profile modal
        showFlashMessage('User profile feature coming soon!', 'info');
    }

    function showGroupSettingsModal() {
        showFlashMessage('Group settings feature coming soon!', 'info');
    }

    function showInviteModal() {
        showFlashMessage('Invite members feature coming soon!', 'info');
    }

    document.getElementById('confirmButton').addEventListener('click', function() {
        if (pendingAction) {
            pendingAction();
        }
    });

    // Close modals on outside click
    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideConfirmModal();
        }
    });

    document.getElementById('memberActionsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideMemberActionsModal();
        }
    });

    // Auto-refresh every 60 seconds
    setInterval(() => {
        const pendingContainer = document.getElementById('pending-requests-container');
        if (pendingContainer && pendingContainer.children.length === 0) {
            location.reload();
        }
    }, 60000);

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>
{% endblock %}
